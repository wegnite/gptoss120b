# 部署指南 - GPT-OSS-120B AI 对话平台

## 1. 部署选项概览

本项目支持多种部署方式：
- **Vercel** (推荐) - 最简单快速
- **Docker** - 容器化部署
- **Cloudflare Workers** - 边缘计算
- **自托管服务器** - 完全控制

## 2. Vercel 部署（推荐）

### 2.1 前置要求
- GitHub 账号
- Vercel 账号
- 至少一个 LLM API Key

### 2.2 一键部署
[![Deploy with Vercel](https://vercel.com/button)](https://vercel.com/new/clone?repository-url=https://github.com/yourusername/gpt-oss-120b)

### 2.3 手动部署步骤

#### Step 1: Fork 或 Clone 项目
```bash
git clone https://github.com/yourusername/gpt-oss-120b.git
cd gpt-oss-120b
```

#### Step 2: 安装依赖
```bash
pnpm install
```

#### Step 3: 配置环境变量
创建 `.env.local` 文件：
```bash
cp .env.example .env.local
```

编辑 `.env.local`：
```env
# 必需 - 至少配置一个
OPENAI_API_KEY=sk-...
# 或
DEEPSEEK_API_KEY=sk-...
# 或
ANTHROPIC_API_KEY=sk-ant-...

# 可选配置
DEFAULT_MODEL=gpt-3.5-turbo
DEFAULT_TEMPERATURE=0.7
DEFAULT_MAX_TOKENS=2000

# 生产环境配置
NEXT_PUBLIC_APP_URL=https://your-domain.com
```

#### Step 4: 本地测试
```bash
pnpm dev
# 访问 http://localhost:3000
```

#### Step 5: 部署到 Vercel
```bash
# 安装 Vercel CLI
pnpm add -g vercel

# 登录 Vercel
vercel login

# 部署
vercel --prod
```

### 2.4 Vercel 配置

#### vercel.json
```json
{
  "buildCommand": "pnpm build",
  "outputDirectory": ".next",
  "devCommand": "pnpm dev",
  "installCommand": "pnpm install",
  "framework": "nextjs",
  "functions": {
    "app/api/chat/route.ts": {
      "maxDuration": 60
    }
  },
  "env": {
    "OPENAI_API_KEY": "@openai-api-key",
    "DEEPSEEK_API_KEY": "@deepseek-api-key",
    "ANTHROPIC_API_KEY": "@anthropic-api-key"
  }
}
```

#### 环境变量设置
1. 登录 Vercel Dashboard
2. 选择项目 -> Settings -> Environment Variables
3. 添加必要的环境变量
4. 重新部署

### 2.5 自定义域名
1. 在 Vercel Dashboard 中选择项目
2. Settings -> Domains
3. 添加自定义域名
4. 配置 DNS 记录

## 3. Docker 部署

### 3.1 Dockerfile
```dockerfile
# 多阶段构建
FROM node:20-alpine AS base

# 依赖安装阶段
FROM base AS deps
RUN apk add --no-cache libc6-compat
WORKDIR /app

# 复制依赖文件
COPY package.json pnpm-lock.yaml ./
RUN corepack enable pnpm && pnpm install --frozen-lockfile

# 构建阶段
FROM base AS builder
WORKDIR /app
COPY --from=deps /app/node_modules ./node_modules
COPY . .

# 设置环境变量
ENV NEXT_TELEMETRY_DISABLED 1

# 构建应用
RUN corepack enable pnpm && pnpm build

# 运行阶段
FROM base AS runner
WORKDIR /app

ENV NODE_ENV production
ENV NEXT_TELEMETRY_DISABLED 1

# 创建非 root 用户
RUN addgroup --system --gid 1001 nodejs
RUN adduser --system --uid 1001 nextjs

# 复制构建产物
COPY --from=builder /app/public ./public
COPY --from=builder --chown=nextjs:nodejs /app/.next/standalone ./
COPY --from=builder --chown=nextjs:nodejs /app/.next/static ./.next/static

USER nextjs

EXPOSE 3000

ENV PORT 3000
ENV HOSTNAME "0.0.0.0"

CMD ["node", "server.js"]
```

### 3.2 docker-compose.yml
```yaml
version: '3.8'

services:
  app:
    build: .
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - DEEPSEEK_API_KEY=${DEEPSEEK_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL}
    volumes:
      - ./data:/app/data
    restart: unless-stopped
    networks:
      - app-network

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - app-network

  postgres:
    image: postgres:15-alpine
    environment:
      - POSTGRES_USER=gptoss
      - POSTGRES_PASSWORD=${DB_PASSWORD}
      - POSTGRES_DB=gptoss
    volumes:
      - postgres-data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    networks:
      - app-network

networks:
  app-network:
    driver: bridge

volumes:
  redis-data:
  postgres-data:
```

### 3.3 构建和运行
```bash
# 构建镜像
docker build -t gpt-oss-120b .

# 运行容器
docker run -d \
  -p 3000:3000 \
  -e OPENAI_API_KEY=sk-... \
  -e DEEPSEEK_API_KEY=sk-... \
  --name gpt-oss-120b \
  gpt-oss-120b

# 使用 docker-compose
docker-compose up -d

# 查看日志
docker logs -f gpt-oss-120b
```

## 4. Cloudflare Workers 部署

### 4.1 安装 Wrangler
```bash
pnpm add -g wrangler
```

### 4.2 wrangler.toml
```toml
name = "gpt-oss-120b"
main = "worker.js"
compatibility_date = "2024-01-01"

[env.production]
vars = { ENVIRONMENT = "production" }

[[kv_namespaces]]
binding = "CACHE"
id = "your-kv-namespace-id"

[secrets]
OPENAI_API_KEY
DEEPSEEK_API_KEY
ANTHROPIC_API_KEY
```

### 4.3 Worker 脚本
```javascript
// worker.js
export default {
  async fetch(request, env, ctx) {
    const url = new URL(request.url);
    
    // 处理 API 路由
    if (url.pathname.startsWith('/api/')) {
      return handleAPI(request, env);
    }
    
    // 返回静态资源
    return fetch(request);
  },
};

async function handleAPI(request, env) {
  if (request.method === 'POST' && request.url.includes('/api/chat')) {
    const body = await request.json();
    
    // 调用 LLM API
    const response = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${env.OPENAI_API_KEY}`
      },
      body: JSON.stringify({
        model: body.model || 'gpt-3.5-turbo',
        messages: body.messages,
        stream: true
      })
    });
    
    return new Response(response.body, {
      headers: {
        'Content-Type': 'text/event-stream',
        'Cache-Control': 'no-cache',
      }
    });
  }
  
  return new Response('Not Found', { status: 404 });
}
```

### 4.4 部署到 Cloudflare
```bash
# 登录 Cloudflare
wrangler login

# 设置密钥
wrangler secret put OPENAI_API_KEY
wrangler secret put DEEPSEEK_API_KEY

# 部署
wrangler deploy
```

## 5. 自托管服务器部署

### 5.1 使用 PM2
```bash
# 安装 PM2
npm install -g pm2

# 构建项目
pnpm build

# 启动应用
pm2 start ecosystem.config.js

# 保存 PM2 配置
pm2 save

# 设置开机自启
pm2 startup
```

#### ecosystem.config.js
```javascript
module.exports = {
  apps: [{
    name: 'gpt-oss-120b',
    script: 'node_modules/next/dist/bin/next',
    args: 'start',
    instances: 'max',
    exec_mode: 'cluster',
    env: {
      NODE_ENV: 'production',
      PORT: 3000
    },
    error_file: './logs/err.log',
    out_file: './logs/out.log',
    log_file: './logs/combined.log',
    time: true
  }]
};
```

### 5.2 Nginx 反向代理
```nginx
# /etc/nginx/sites-available/gpt-oss-120b
server {
    listen 80;
    server_name your-domain.com;

    # 重定向到 HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name your-domain.com;

    # SSL 证书
    ssl_certificate /etc/letsencrypt/live/your-domain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/your-domain.com/privkey.pem;

    # SSL 配置
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    # 日志
    access_log /var/log/nginx/gpt-oss-120b.access.log;
    error_log /var/log/nginx/gpt-oss-120b.error.log;

    # 反向代理
    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # SSE 支持
        proxy_buffering off;
        proxy_cache off;
        proxy_read_timeout 86400;
    }

    # 静态文件缓存
    location /_next/static {
        proxy_pass http://localhost:3000;
        proxy_cache_valid 60m;
        add_header Cache-Control "public, immutable";
    }
}
```

### 5.3 SSL 证书配置
```bash
# 安装 Certbot
sudo apt update
sudo apt install certbot python3-certbot-nginx

# 获取证书
sudo certbot --nginx -d your-domain.com

# 自动更新
sudo certbot renew --dry-run
```

## 6. 环境配置

### 6.1 生产环境变量
```env
# .env.production
NODE_ENV=production
NEXT_PUBLIC_APP_URL=https://your-domain.com

# API Keys (使用密钥管理服务更安全)
OPENAI_API_KEY=sk-...
DEEPSEEK_API_KEY=sk-...
ANTHROPIC_API_KEY=sk-ant-...

# 数据库
DATABASE_URL=postgresql://user:password@localhost:5432/gptoss

# Redis
REDIS_URL=redis://localhost:6379

# 监控
SENTRY_DSN=https://...@sentry.io/...
GOOGLE_ANALYTICS_ID=G-...

# 安全
JWT_SECRET=your-secret-key-min-32-chars
ENCRYPTION_KEY=your-encryption-key

# Rate Limiting
RATE_LIMIT_REQUESTS=100
RATE_LIMIT_WINDOW=60000

# CORS
ALLOWED_ORIGINS=https://your-domain.com,https://www.your-domain.com
```

### 6.2 密钥管理最佳实践
```bash
# 使用环境变量服务
# Vercel
vercel env add OPENAI_API_KEY production

# AWS Secrets Manager
aws secretsmanager create-secret \
  --name gpt-oss-120b/api-keys \
  --secret-string '{"openai":"sk-...","deepseek":"sk-..."}'

# HashiCorp Vault
vault kv put secret/gpt-oss-120b \
  openai_api_key=sk-... \
  deepseek_api_key=sk-...
```

## 7. 性能优化

### 7.1 CDN 配置
```javascript
// next.config.js
module.exports = {
  images: {
    domains: ['cdn.your-domain.com'],
    loader: 'cloudinary',
  },
  assetPrefix: process.env.NODE_ENV === 'production' 
    ? 'https://cdn.your-domain.com' 
    : '',
};
```

### 7.2 缓存策略
```javascript
// 页面缓存
export const revalidate = 3600; // 1 小时

// API 路由缓存
export async function GET(request) {
  const response = await fetch('...');
  
  return new Response(response.body, {
    headers: {
      'Cache-Control': 'public, s-maxage=60, stale-while-revalidate=30',
    },
  });
}
```

## 8. 监控和日志

### 8.1 Sentry 集成
```javascript
// sentry.client.config.js
import * as Sentry from "@sentry/nextjs";

Sentry.init({
  dsn: process.env.SENTRY_DSN,
  environment: process.env.NODE_ENV,
  tracesSampleRate: 1.0,
  debug: false,
});
```

### 8.2 日志管理
```javascript
// lib/logger.ts
import winston from 'winston';
import { Logtail } from '@logtail/node';

const logtail = new Logtail(process.env.LOGTAIL_TOKEN);

export const logger = winston.createLogger({
  transports: [
    new winston.transports.Console(),
    new winston.transports.File({ filename: 'app.log' }),
    logtail.winston(),
  ],
});
```

## 9. 备份和恢复

### 9.1 数据库备份
```bash
# PostgreSQL 备份
pg_dump -U postgres -d gptoss > backup_$(date +%Y%m%d).sql

# 恢复
psql -U postgres -d gptoss < backup_20240101.sql

# 自动备份脚本
#!/bin/bash
BACKUP_DIR="/backups"
DB_NAME="gptoss"
DATE=$(date +%Y%m%d_%H%M%S)

pg_dump -U postgres -d $DB_NAME | gzip > $BACKUP_DIR/backup_$DATE.sql.gz

# 保留最近 7 天的备份
find $BACKUP_DIR -name "backup_*.sql.gz" -mtime +7 -delete
```

### 9.2 定时任务
```bash
# 添加 crontab
crontab -e

# 每天凌晨 2 点备份
0 2 * * * /path/to/backup.sh

# 每小时检查健康状态
0 * * * * curl -f https://your-domain.com/api/health || alert
```

## 10. 故障排查

### 10.1 常见问题

#### 构建失败
```bash
# 清理缓存
rm -rf .next node_modules
pnpm install
pnpm build
```

#### 内存不足
```javascript
// next.config.js
module.exports = {
  experimental: {
    workerThreads: false,
    cpus: 1,
  },
};
```

#### API 超时
```javascript
// vercel.json
{
  "functions": {
    "app/api/chat/route.ts": {
      "maxDuration": 60  // 最大 60 秒
    }
  }
}
```

### 10.2 健康检查
```typescript
// app/api/health/route.ts
export async function GET() {
  const checks = {
    app: 'ok',
    database: await checkDatabase(),
    redis: await checkRedis(),
    apis: await checkAPIs(),
  };

  const allOk = Object.values(checks).every(v => v === 'ok');
  
  return Response.json(
    { status: allOk ? 'healthy' : 'unhealthy', checks },
    { status: allOk ? 200 : 503 }
  );
}
```

## 11. 安全加固

### 11.1 安全头
```javascript
// middleware.ts
export function middleware(request: NextRequest) {
  const response = NextResponse.next();
  
  response.headers.set('X-Frame-Options', 'DENY');
  response.headers.set('X-Content-Type-Options', 'nosniff');
  response.headers.set('X-XSS-Protection', '1; mode=block');
  response.headers.set('Referrer-Policy', 'strict-origin-when-cross-origin');
  response.headers.set(
    'Content-Security-Policy',
    "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline';"
  );
  
  return response;
}
```

### 11.2 防火墙规则
```bash
# UFW 配置
sudo ufw default deny incoming
sudo ufw default allow outgoing
sudo ufw allow ssh
sudo ufw allow 80
sudo ufw allow 443
sudo ufw enable
```

## 12. 更新和维护

### 12.1 更新流程
```bash
# 1. 备份当前版本
cp -r /app/gpt-oss-120b /backup/gpt-oss-120b-$(date +%Y%m%d)

# 2. 拉取最新代码
git pull origin main

# 3. 安装依赖
pnpm install

# 4. 运行迁移
pnpm prisma migrate deploy

# 5. 构建新版本
pnpm build

# 6. 重启服务
pm2 restart gpt-oss-120b

# 7. 验证
curl https://your-domain.com/api/health
```

### 12.2 回滚流程
```bash
# 1. 停止服务
pm2 stop gpt-oss-120b

# 2. 恢复备份
rm -rf /app/gpt-oss-120b
cp -r /backup/gpt-oss-120b-20240101 /app/gpt-oss-120b

# 3. 重启服务
pm2 start gpt-oss-120b

# 4. 验证
curl https://your-domain.com/api/health
```

## 13. 监控指标

### 关键指标
- **可用性**: > 99.9%
- **响应时间**: P50 < 200ms, P99 < 1s
- **错误率**: < 0.1%
- **并发用户**: 支持 1000+

### 告警配置
```javascript
// 配置告警规则
const alerts = {
  highErrorRate: {
    condition: 'error_rate > 1%',
    action: 'email + slack',
  },
  slowResponse: {
    condition: 'p99_latency > 2s',
    action: 'email',
  },
  lowAvailability: {
    condition: 'uptime < 99%',
    action: 'email + pagerduty',
  },
};
```

## 14. 成本优化

### 优化建议
1. 使用 CDN 减少带宽成本
2. 实施缓存策略减少 API 调用
3. 使用更便宜的模型处理简单任务
4. 监控和限制每用户使用量
5. 使用 Spot 实例或预留实例

## 15. 合规性

### GDPR 合规
- 实施数据删除功能
- 提供数据导出功能
- 明确的隐私政策
- 用户同意机制

### 数据保护
- 加密敏感数据
- 定期安全审计
- 访问日志记录
- 数据最小化原则