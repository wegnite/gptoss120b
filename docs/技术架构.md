# 技术架构文档 - GPT-OSS-120B AI 对话平台

## 1. 系统架构概览

```
┌──────────────────────────────────────────────────────────┐
│                     客户端 (Browser)                       │
│                   React + Next.js 15.2                    │
└──────────────────────────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────┐
│                    Next.js 应用层                         │
│         ┌──────────────┬──────────────┬──────────────┐   │
│         │   SSR Pages  │  API Routes  │  Middleware  │   │
│         └──────────────┴──────────────┴──────────────┘   │
└──────────────────────────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────┐
│                      服务层                               │
│    ┌───────────┬───────────┬───────────┬───────────┐    │
│    │   Chat    │   Auth    │  Storage  │   Cache   │    │
│    │  Service  │  Service  │  Service  │  Service  │    │
│    └───────────┴───────────┴───────────┴───────────┘    │
└──────────────────────────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────┐
│                      外部服务                             │
│    ┌───────────┬───────────┬───────────┬───────────┐    │
│    │    LLM    │ Database  │   Redis   │    CDN    │    │
│    │    APIs   │(Supabase) │  (Cache)  │ (Static)  │    │
│    └───────────┴───────────┴───────────┴───────────┘    │
└──────────────────────────────────────────────────────────┘
```

## 2. 技术栈详细说明

### 2.1 前端技术

#### 核心框架
- **Next.js 15.2**: App Router 架构
- **React 19**: 最新特性支持
- **TypeScript 5.x**: 类型安全

#### UI 框架
- **Tailwind CSS 3.x**: 原子化 CSS
- **shadcn/ui**: 组件库
- **Radix UI**: 无样式组件基础

#### 状态管理
- **Zustand**: 轻量级状态管理（v1.1+）
- **React Context**: 主题和全局设置
- **TanStack Query**: 服务端状态管理（v1.1+）

#### 工具库
- **react-markdown**: Markdown 渲染
- **prism-react-renderer**: 代码高亮
- **framer-motion**: 动画效果
- **react-hook-form**: 表单处理
- **zod**: 数据验证

### 2.2 后端技术

#### API 层
- **Next.js API Routes**: RESTful API
- **tRPC**: 类型安全的 API（可选）
- **Edge Runtime**: 边缘计算支持

#### 数据库（v1.1+）
- **Supabase**: PostgreSQL + 实时功能
- **Prisma**: ORM 工具
- **数据库结构**:
  ```sql
  - users (用户表)
  - conversations (对话表)
  - messages (消息表)
  - settings (设置表)
  - api_keys (API密钥表)
  ```

#### 缓存层
- **Vercel KV**: Redis 兼容缓存
- **本地缓存**: LRU Cache
- **CDN 缓存**: 静态资源

### 2.3 AI 集成架构

#### LLM Provider 抽象层
```typescript
interface LLMProvider {
  name: string;
  generateStream(prompt: string, options: GenerateOptions): AsyncGenerator<string>;
  generateCompletion(prompt: string, options: GenerateOptions): Promise<string>;
}
```

#### 支持的 Providers
1. **OpenAI Compatible**
   - GPT-OSS-120B endpoint
   - Custom OpenAI-like APIs

2. **DeepSeek**
   - DeepSeek-V3
   - DeepSeek-Coder

3. **本地模型**（未来）
   - Ollama integration
   - llama.cpp

## 3. 核心模块设计

### 3.1 对话管理模块

```typescript
// 对话流程
interface ChatFlow {
  1. 用户输入
  2. 输入预处理（清理、验证）
  3. 构建 Prompt（系统提示 + 历史 + 用户输入）
  4. 调用 LLM API
  5. 流式响应处理
  6. 响应后处理（Markdown、代码块）
  7. 存储到历史记录
  8. 返回给用户
}
```

### 3.2 流式响应架构

```typescript
// Server-Sent Events (SSE) 实现
export async function POST(req: Request) {
  const encoder = new TextEncoder();
  const stream = new TransformStream();
  const writer = stream.writable.getWriter();

  // 异步处理 LLM 响应
  (async () => {
    const llmStream = await llmProvider.generateStream(prompt);
    for await (const chunk of llmStream) {
      await writer.write(encoder.encode(`data: ${chunk}\n\n`));
    }
    await writer.close();
  })();

  return new Response(stream.readable, {
    headers: {
      'Content-Type': 'text/event-stream',
      'Cache-Control': 'no-cache',
      'Connection': 'keep-alive',
    },
  });
}
```

### 3.3 认证系统（v1.1+）

```typescript
// 使用 NextAuth.js
interface AuthFlow {
  1. Email/密码注册登录
  2. OAuth（Google、GitHub）
  3. Session 管理
  4. JWT Token
  5. 权限控制
}
```

## 4. 目录结构设计

```
gpt-oss-120b/
├── app/
│   ├── (chat)/               # 聊天相关页面
│   │   ├── page.tsx          # 主聊天页面
│   │   └── layout.tsx        # 聊天布局
│   ├── api/
│   │   ├── chat/             # 聊天 API
│   │   │   └── route.ts      # 流式响应
│   │   ├── conversations/    # 对话管理 API
│   │   └── models/           # 模型配置 API
│   └── layout.tsx            # 根布局
├── components/
│   ├── chat/                 # 聊天组件
│   │   ├── ChatInput.tsx
│   │   ├── ChatMessage.tsx
│   │   ├── ChatList.tsx
│   │   └── ChatSidebar.tsx
│   ├── ui/                   # shadcn/ui 组件
│   └── providers/            # Context Providers
├── lib/
│   ├── llm/                  # LLM 集成
│   │   ├── providers/        # 各种 Provider 实现
│   │   └── index.ts          # 统一接口
│   ├── utils/                # 工具函数
│   └── hooks/                # 自定义 Hooks
├── services/                 # 业务服务
│   ├── chat.ts              # 聊天服务
│   ├── conversation.ts      # 对话管理
│   └── storage.ts           # 存储服务
├── types/                    # TypeScript 类型
│   ├── chat.d.ts
│   └── api.d.ts
└── docs/                     # 项目文档
```

## 5. 数据流设计

### 5.1 实时对话数据流

```
用户输入 → Input组件 → ChatService → API Route 
    ↓                                    ↓
Store更新 ← Message组件 ← SSE Stream ← LLM API
```

### 5.2 状态管理流程

```typescript
// Zustand Store 示例
interface ChatStore {
  conversations: Conversation[];
  currentConversation: Conversation | null;
  messages: Message[];
  isLoading: boolean;
  
  // Actions
  sendMessage: (content: string) => Promise<void>;
  createConversation: () => void;
  switchConversation: (id: string) => void;
  clearConversation: () => void;
}
```

## 6. API 设计

### 6.1 RESTful API 端点

```
POST   /api/chat                 # 发送消息
GET    /api/conversations        # 获取对话列表
POST   /api/conversations        # 创建对话
DELETE /api/conversations/:id    # 删除对话
GET    /api/models               # 获取可用模型
POST   /api/settings             # 更新设置
```

### 6.2 请求/响应格式

```typescript
// 聊天请求
interface ChatRequest {
  message: string;
  conversationId?: string;
  model: string;
  temperature?: number;
  maxTokens?: number;
  systemPrompt?: string;
}

// 流式响应
interface ChatStreamResponse {
  type: 'content' | 'error' | 'done';
  content?: string;
  error?: string;
}
```

## 7. 性能优化策略

### 7.1 前端优化
- **代码分割**: 动态导入和懒加载
- **图片优化**: Next.js Image 组件
- **缓存策略**: SWR 和 React Query
- **虚拟滚动**: 长对话列表优化

### 7.2 后端优化
- **边缘函数**: 降低延迟
- **连接池**: 数据库连接优化
- **Response 缓存**: 相似问题缓存
- **Rate Limiting**: 防止滥用

### 7.3 LLM 调用优化
- **Prompt 缓存**: 重复问题优化
- **Token 优化**: 智能截断历史
- **并发控制**: 队列管理
- **失败重试**: 指数退避

## 8. 安全架构

### 8.1 API 安全
- **API Key 管理**: 服务端存储
- **Rate Limiting**: IP 和用户级别
- **CORS 配置**: 严格域名控制
- **输入验证**: Zod schema 验证

### 8.2 数据安全
- **加密传输**: HTTPS only
- **敏感数据**: 不记录日志
- **XSS 防护**: 内容清理
- **CSRF 防护**: Token 验证

## 9. 监控和日志

### 9.1 监控指标
- **性能监控**: Web Vitals
- **错误追踪**: Sentry
- **用户行为**: Google Analytics
- **API 监控**: 响应时间和错误率

### 9.2 日志策略
```typescript
// 结构化日志
interface LogEntry {
  timestamp: Date;
  level: 'info' | 'warn' | 'error';
  module: string;
  message: string;
  metadata?: Record<string, any>;
}
```

## 10. 部署架构

### 10.1 Vercel 部署
```yaml
# vercel.json
{
  "functions": {
    "app/api/chat/route.ts": {
      "maxDuration": 60
    }
  },
  "env": {
    "LLM_API_KEY": "@llm-api-key",
    "DATABASE_URL": "@database-url"
  }
}
```

### 10.2 Docker 部署
```dockerfile
FROM node:20-alpine
WORKDIR /app
COPY . .
RUN pnpm install
RUN pnpm build
EXPOSE 3000
CMD ["pnpm", "start"]
```

## 11. 扩展性设计

### 11.1 插件系统（v2.0）
- **插件接口**: 标准化 API
- **插件市场**: 社区贡献
- **沙箱执行**: 安全隔离

### 11.2 多租户支持（v2.0）
- **团队空间**: 隔离数据
- **权限系统**: RBAC
- **计费隔离**: 独立计量

## 12. 技术债务管理

### 12.1 代码质量
- **ESLint**: 代码规范
- **Prettier**: 格式化
- **Husky**: Git hooks
- **测试覆盖**: Jest + Testing Library

### 12.2 文档维护
- **API 文档**: OpenAPI/Swagger
- **组件文档**: Storybook
- **架构决策记录**: ADR